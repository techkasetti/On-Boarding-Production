<!-- dynamicFormModal.html -->
<template>
    <template if:true={isOpen}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open" aria-modal="true">
            <div class="slds-modal__container" style="max-width: 600px;">
                <!-- Modal Header -->
                <header class="slds-modal__header slds-theme_shade" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <lightning-button-icon
                        icon-name="utility:close"
                        alternative-text="Close"
                        title="Close"
                        variant="bare-inverse"
                        class="slds-modal__close"
                        onclick={handleClose}
                    ></lightning-button-icon>
                    <h2 class="slds-text-heading_medium slds-hyphenate" style="color: white;">
                        <lightning-icon icon-name={modalIcon} size="small" class="slds-m-right_x-small" style="fill: white;"></lightning-icon>
                        {modalTitle}
                    </h2>
                </header>

                <!-- Modal Body -->
                <div class="slds-modal__content slds-p-around_medium" style="min-height: 300px; max-height: 70vh; overflow-y: auto; overflow-x: visible;">
                    <template if:true={isLoading}>
                        <div class="slds-align_absolute-center slds-p-vertical_xx-large">
                            <lightning-spinner alternative-text="Saving..." size="medium" variant="brand"></lightning-spinner>
                            <p class="slds-m-top_small slds-text-color_weak">Saving your changes...</p>
                        </div>
                    </template>

                    <template if:false={isLoading}>
                        <div class="form-container">
                            <!-- Work Experience Fields -->
                            <template if:true={isWorkExperience}>
                                <div class="slds-form" role="list">
                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Job Title / Role"
                                            value={formData.Role__c}
                                            onchange={handleFieldChange}
                                            data-field="Role__c"
                                            required
                                            field-level-help="Your job title or role in the organization"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Company / Organization"
                                            value={formData.Organization__c}
                                            onchange={handleFieldChange}
                                            data-field="Organization__c"
                                            required
                                            field-level-help="Name of the company or organization"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-grid slds-gutters slds-m-bottom_medium">
                                        <div class="slds-col">
                                            <lightning-input
                                                type="date"
                                                label="Start Date"
                                                value={formData.Start_Date__c}
                                                onchange={handleFieldChange}
                                                data-field="Start_Date__c"
                                                required
                                                field-level-help="When did you start this role?"
                                            ></lightning-input>
                                        </div>
                                        <div class="slds-col">
                                            <lightning-input
                                                type="date"
                                                label="End Date"
                                                value={formData.End_Date__c}
                                                onchange={handleFieldChange}
                                                data-field="End_Date__c"
                                                field-level-help="Leave blank if currently employed"
                                            ></lightning-input>
                                        </div>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_small">
                                        <lightning-input
                                            type="checkbox"
                                            label="Currently Working Here"
                                            checked={formData.Is_Current__c}
                                            onchange={handleCheckboxChange}
                                            data-field="Is_Current__c"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item" role="listitem">
                                        <lightning-textarea
                                            label="Responsibilities & Achievements"
                                            value={formData.Responsibilities__c}
                                            onchange={handleFieldChange}
                                            data-field="Responsibilities__c"
                                            rows="5"
                                            placeholder="Describe your key responsibilities and accomplishments..."
                                            field-level-help="Detail your main duties and notable achievements"
                                        ></lightning-textarea>
                                    </div>
                                </div>
                            </template>

                            <!-- Education Fields -->
                            <template if:true={isEducation}>
                                <div class="slds-form" role="list">
                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Institution / University"
                                            value={formData.Institution__c}
                                            onchange={handleFieldChange}
                                            data-field="Institution__c"
                                            required
                                            field-level-help="Name of the educational institution"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Degree / Qualification"
                                            value={formData.Degree__c}
                                            onchange={handleFieldChange}
                                            data-field="Degree__c"
                                            required
                                            placeholder="e.g., MBBS, Bachelor of Science"
                                            field-level-help="Your degree or qualification earned"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-grid slds-gutters slds-m-bottom_medium">
                                        <div class="slds-col">
                                            <lightning-input
                                                type="text"
                                                label="Start Year"
                                                value={formData.Start_Year__c}
                                                onchange={handleYearChange}
                                                data-field="Start_Year__c"
                                                pattern="[0-9]{4}"
                                                message-when-pattern-mismatch="Please enter a 4-digit year"
                                                maxlength="4"
                                                placeholder="2015"
                                                required
                                                field-level-help="Year you started (e.g., 2015)"
                                            ></lightning-input>
                                        </div>
                                        <div class="slds-col">
                                            <lightning-input
                                                type="text"
                                                label="End Year"
                                                value={formData.End_Year__c}
                                                onchange={handleYearChange}
                                                data-field="End_Year__c"
                                                pattern="[0-9]{4}"
                                                message-when-pattern-mismatch="Please enter a 4-digit year"
                                                maxlength="4"
                                                placeholder="2020"
                                                field-level-help="Year you completed (e.g., 2020)"
                                            ></lightning-input>
                                        </div>
                                    </div>

                                    <div class="slds-form__item" role="listitem">
                                        <lightning-textarea
                                            label="Details"
                                            value={formData.Details__c}
                                            onchange={handleFieldChange}
                                            data-field="Details__c"
                                            rows="4"
                                            placeholder="GPA, honors, activities, coursework..."
                                            field-level-help="Additional details about your education"
                                        ></lightning-textarea>
                                    </div>
                                </div>
                            </template>

                            <!-- License/Certification Fields -->
                            <template if:true={isLicense}>
                                <div class="slds-form" role="list">
                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Certification Name"
                                            value={formData.Name}
                                            onchange={handleFieldChange}
                                            data-field="Name"
                                            required
                                            placeholder="e.g., Basic Life Support (BLS)"
                                            field-level-help="Name of the license or certification"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label" for="license-type">
                                                <span>Type</span>
                                            </label>
                                            <div class="slds-form-element__control">
                                                <lightning-combobox
                                                    name="licenseType"
                                                    value={formData.Type__c}
                                                    placeholder="Select Type"
                                                    options={licenseTypeOptions}
                                                    onchange={handlePicklistChange}
                                                    data-field="Type__c"
                                                    variant="label-hidden"
                                                    dropdown-alignment="auto"
                                                ></lightning-combobox>
                                            </div>
                                            <div class="slds-form-element__help" id="license-type-help">Type of certification or license</div>
                                        </div>
                                    </div>

                                    <div class="slds-grid slds-gutters slds-m-bottom_medium">
                                        <div class="slds-col">
                                            <lightning-input
                                                type="date"
                                                label="Issue Date"
                                                value={formData.Issue_Date__c}
                                                onchange={handleFieldChange}
                                                data-field="Issue_Date__c"
                                                field-level-help="When was this issued?"
                                            ></lightning-input>
                                        </div>
                                        <div class="slds-col">
                                            <lightning-input
                                                type="date"
                                                label="Expiry Date"
                                                value={formData.Expiry_Date__c}
                                                onchange={handleFieldChange}
                                                data-field="Expiry_Date__c"
                                                field-level-help="When does this expire?"
                                            ></lightning-input>
                                        </div>
                                    </div>

                                    <div class="slds-form__item" role="listitem">
                                        <lightning-textarea
                                            label="Notes"
                                            value={formData.Notes__c}
                                            onchange={handleFieldChange}
                                            data-field="Notes__c"
                                            rows="3"
                                            placeholder="Issuing organization, credential ID, etc..."
                                            field-level-help="Additional information about the certification"
                                        ></lightning-textarea>
                                    </div>
                                </div>
                            </template>

                            <!-- Clinical Skill Fields -->
                            <template if:true={isClinicalSkill}>
                                <div class="slds-form" role="list">
                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Skill Name"
                                            value={formData.Name}
                                            onchange={handleFieldChange}
                                            data-field="Name"
                                            required
                                            placeholder="e.g., Patient Assessment"
                                            field-level-help="Name of the clinical skill"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">
                                                <span>Skill Type</span>
                                            </label>
                                            <div class="slds-form-element__control">
                                                <lightning-combobox
                                                    name="skillType"
                                                    value={formData.Skill_Type__c}
                                                    placeholder="Select Skill Type"
                                                    options={clinicalSkillTypeOptions}
                                                    onchange={handlePicklistChange}
                                                    data-field="Skill_Type__c"
                                                    variant="label-hidden"
                                                    dropdown-alignment="auto"
                                                ></lightning-combobox>
                                            </div>
                                            <div class="slds-form-element__help">Category of clinical skill</div>
                                        </div>
                                    </div>

                                    <div class="slds-form__item" role="listitem">
                                        <lightning-textarea
                                            label="Description"
                                            value={formData.Description__c}
                                            onchange={handleFieldChange}
                                            data-field="Description__c"
                                            rows="3"
                                            placeholder="Describe your proficiency and experience..."
                                            field-level-help="Details about your skill level and experience"
                                        ></lightning-textarea>
                                    </div>
                                </div>
                            </template>

                            <!-- Technical Skill Fields -->
                            <template if:true={isTechnicalSkill}>
                                <div class="slds-form" role="list">
                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Skill Name"
                                            value={formData.Name}
                                            onchange={handleFieldChange}
                                            data-field="Name"
                                            required
                                            placeholder="e.g., EMR/EHR Systems"
                                            field-level-help="Name of the technical skill"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">
                                                <span>Category</span>
                                            </label>
                                            <div class="slds-form-element__control">
                                                <lightning-combobox
                                                    name="techCategory"
                                                    value={formData.Category__c}
                                                    placeholder="Select Category"
                                                    options={technicalSkillCategoryOptions}
                                                    onchange={handlePicklistChange}
                                                    data-field="Category__c"
                                                    variant="label-hidden"
                                                    dropdown-alignment="auto"
                                                ></lightning-combobox>
                                            </div>
                                            <div class="slds-form-element__help">Category of the technical skill</div>
                                        </div>
                                    </div>

                                    <div class="slds-form__item" role="listitem">
                                        <lightning-textarea
                                            label="Description"
                                            value={formData.Description__c}
                                            onchange={handleFieldChange}
                                            data-field="Description__c"
                                            rows="3"
                                            placeholder="Describe your proficiency and projects..."
                                            field-level-help="Details about your skill level and experience"
                                        ></lightning-textarea>
                                    </div>
                                </div>
                            </template>

                            <!-- Procedure Fields -->
                            <template if:true={isProcedure}>
                                <div class="slds-form" role="list">
                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Procedure Name"
                                            value={formData.Name}
                                            onchange={handleFieldChange}
                                            data-field="Name"
                                            required
                                            placeholder="e.g., IV Cannulation"
                                            field-level-help="Name of the procedure"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">
                                                <span>Category</span>
                                            </label>
                                            <div class="slds-form-element__control">
                                                <lightning-combobox
                                                    name="procedureCategory"
                                                    value={formData.Category__c}
                                                    placeholder="Select Category"
                                                    options={procedureCategoryOptions}
                                                    onchange={handlePicklistChange}
                                                    data-field="Category__c"
                                                    variant="label-hidden"
                                                    dropdown-alignment="auto"
                                                ></lightning-combobox>
                                            </div>
                                            <div class="slds-form-element__help">Type of procedure</div>
                                        </div>
                                    </div>

                                    <div class="slds-form__item" role="listitem">
                                        <lightning-textarea
                                            label="Notes"
                                            value={formData.Notes__c}
                                            onchange={handleFieldChange}
                                            data-field="Notes__c"
                                            rows="3"
                                            placeholder="Additional details about the procedure..."
                                            field-level-help="Any relevant notes"
                                        ></lightning-textarea>
                                    </div>
                                </div>
                            </template>

                            <!-- Internship Fields -->
                            <template if:true={isInternship}>
                                <div class="slds-form" role="list">
                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Organization"
                                            value={formData.Organization__c}
                                            onchange={handleFieldChange}
                                            data-field="Organization__c"
                                            required
                                            placeholder="e.g., City General Hospital"
                                            field-level-help="Name of the organization"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-grid slds-gutters slds-m-bottom_medium">
                                        <div class="slds-col">
                                            <lightning-input
                                                type="date"
                                                label="Start Date"
                                                value={formData.Start_Date__c}
                                                onchange={handleFieldChange}
                                                data-field="Start_Date__c"
                                                required
                                                field-level-help="Internship start date"
                                            ></lightning-input>
                                        </div>
                                        <div class="slds-col">
                                            <lightning-input
                                                type="date"
                                                label="End Date"
                                                value={formData.End_Date__c}
                                                onchange={handleFieldChange}
                                                data-field="End_Date__c"
                                                required
                                                field-level-help="Internship end date"
                                            ></lightning-input>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <!-- Research/Publication Fields -->
                            <template if:true={isResearch}>
                                <div class="slds-form" role="list">
                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Title"
                                            value={formData.Title__c}
                                            onchange={handleFieldChange}
                                            data-field="Title__c"
                                            required
                                            placeholder="e.g., Impact of Lifestyle Modification"
                                            field-level-help="Title of research or publication"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label">
                                                <span>Type</span>
                                            </label>
                                            <div class="slds-form-element__control">
                                                <lightning-combobox
                                                    name="researchType"
                                                    value={formData.Type__c}
                                                    placeholder="Select Type"
                                                    options={researchTypeOptions}
                                                    onchange={handlePicklistChange}
                                                    data-field="Type__c"
                                                    variant="label-hidden"
                                                    dropdown-alignment="auto"
                                                ></lightning-combobox>
                                            </div>
                                            <div class="slds-form-element__help">Type of research or publication</div>
                                        </div>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            type="date"
                                            label="Publication Date"
                                            value={formData.Publication_Date__c}
                                            onchange={handleFieldChange}
                                            data-field="Publication_Date__c"
                                            field-level-help="When was this published or presented?"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item" role="listitem">
                                        <lightning-textarea
                                            label="Description"
                                            value={formData.Description__c}
                                            onchange={handleFieldChange}
                                            data-field="Description__c"
                                            rows="4"
                                            placeholder="Full description of the research..."
                                            field-level-help="Details about the research or publication"
                                        ></lightning-textarea>
                                    </div>
                                </div>
                            </template>

                            <!-- Membership Fields -->
                            <template if:true={isMembership}>
                                <div class="slds-form" role="list">
                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Organization Name"
                                            value={formData.Organization_Name__c}
                                            onchange={handleFieldChange}
                                            data-field="Organization_Name__c"
                                            required
                                            placeholder="e.g., Indian Medical Association"
                                            field-level-help="Name of the professional organization"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Membership Type"
                                            value={formData.Membership_Type__c}
                                            onchange={handleFieldChange}
                                            data-field="Membership_Type__c"
                                            placeholder="e.g., Professional Association"
                                            field-level-help="Type of membership"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item slds-m-bottom_medium" role="listitem">
                                        <lightning-input
                                            label="Member ID"
                                            value={formData.Member_Id__c}
                                            onchange={handleFieldChange}
                                            data-field="Member_Id__c"
                                            placeholder="e.g., IMA12345"
                                            field-level-help="Your membership identification number"
                                        ></lightning-input>
                                    </div>

                                    <div class="slds-form__item" role="listitem">
                                        <lightning-input
                                            type="date"
                                            label="Member Since"
                                            value={formData.Member_Since__c}
                                            onchange={handleFieldChange}
                                            data-field="Member_Since__c"
                                            field-level-help="When did you join?"
                                        ></lightning-input>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Error Message -->
                        <template if:true={errorMessage}>
                            <div class="slds-m-top_medium">
                                <div class="slds-notify slds-notify_alert slds-theme_error" role="alert" style="animation: slideIn 0.3s ease-out;">
                                    <span class="slds-assistive-text">error</span>
                                    <lightning-icon icon-name="utility:error" size="x-small" variant="error" class="slds-m-right_x-small"></lightning-icon>
                                    <h2>{errorMessage}</h2>
                                </div>
                            </div>
                        </template>
                    </template>
                </div>

                <!-- Modal Footer -->
                <footer class="slds-modal__footer slds-theme_shade">
                    <lightning-button
                        label="Cancel"
                        onclick={handleClose}
                        disabled={isLoading}
                        class="slds-m-right_x-small"
                    ></lightning-button>
                    <lightning-button
                        label={saveButtonLabel}
                        variant="brand"
                        onclick={handleSave}
                        disabled={isLoading}
                        icon-name="utility:save"
                    ></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open" style="animation: fadeIn 0.3s ease-out;"></div>
    </template>
</template>