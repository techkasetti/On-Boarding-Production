<template>
    <div class="slds-backdrop slds-backdrop_open"></div>

    <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large">
        <div class="slds-modal__container">

            <!-- Header -->
            <header class="slds-modal__header">
                <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse" 
                        title="Close" 
                        onclick={handleCancel}
                        disabled={isProcessing}>
                    <lightning-icon icon-name="utility:close" size="small" alternative-text="Close"></lightning-icon>
                    <span class="slds-assistive-text">Close</span>
                </button>
                <h2 class="slds-modal__title slds-hyphenate">
                    Upload Resume
                </h2>
            </header>

            <!-- Body -->
            <div class="slds-modal__content slds-p-around_medium" style="min-height: 400px;">

                <!-- AI Parsing Info -->
                <template if:true={showUploader}>
                    <template if:true={useAiParsing}>
                        <div class="slds-notify slds-notify_alert slds-theme_info slds-m-bottom_medium" role="alert">
                            <span class="slds-assistive-text">Info</span>
                            <lightning-icon icon-name="utility:info" size="x-small" variant="inverse" class="slds-m-right_x-small"></lightning-icon>
                            <h2>AI-Powered Resume Parsing Enabled</h2>
                            <p class="slds-m-top_xx-small">Your resume will be automatically analyzed.</p>
                        </div>
                    </template>

                    <template if:false={useAiParsing}>
                        <div class="slds-notify slds-notify_alert slds-theme_warning slds-m-bottom_medium" role="alert">
                            <span class="slds-assistive-text">Info</span>
                            <lightning-icon icon-name="utility:warning" size="x-small" variant="inverse" class="slds-m-right_x-small"></lightning-icon>
                            <h2>Manual Upload Mode</h2>
                            <p class="slds-m-top_xx-small">Resume will be uploaded without parsing.</p>
                        </div>
                    </template>
                </template>

                <!-- âš¡ NEW: Custom File Upload (No nested modal!) -->
                <template if:true={showUploader}>
                    <div class="slds-form-element slds-m-bottom_medium">
                        <label class="slds-form-element__label" for="file-upload-input">
                            <abbr class="slds-required" title="required">*</abbr>
                            Upload Resume (PDF, DOC, DOCX)
                        </label>
                        <div class="slds-form-element__control">
                            <div class="slds-file-selector slds-file-selector_files">
                                <div class="slds-file-selector__dropzone">
                                    <input 
                                        type="file" 
                                        id="file-upload-input"
                                        class="slds-file-selector__input slds-assistive-text" 
                                        accept=".pdf,.doc,.docx"
                                        onchange={handleFileChange}
                                        aria-label="Resume file upload"
                                    />
                                    <label class="slds-file-selector__body" for="file-upload-input">
                                        <span class="slds-file-selector__button slds-button slds-button_neutral">
                                            <lightning-icon icon-name="utility:upload" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                                            Upload Files
                                        </span>
                                        <span class="slds-file-selector__text slds-medium-show">or Drop Files</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Show selected file -->
                        <template if:true={selectedFileName}>
                            <div class="slds-m-top_small">
                                <div class="slds-file slds-file_card">
                                    <figure>
                                        <div class="slds-file__crop">
                                            <lightning-icon icon-name="doctype:pdf" size="large"></lightning-icon>
                                        </div>
                                        <figcaption class="slds-file__title slds-file__title_card">
                                            <div class="slds-media slds-media_small slds-media_center">
                                                <div class="slds-media__body">
                                                    <span class="slds-file__text slds-truncate" title={selectedFileName}>{selectedFileName}</span>
                                                </div>
                                            </div>
                                        </figcaption>
                                    </figure>
                                </div>
                                
                                <lightning-button 
                                    variant="brand" 
                                    label="Upload & Process"
                                    onclick={handleManualUpload}
                                    disabled={isProcessing}
                                    class="slds-m-top_small">
                                </lightning-button>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- Processing Spinner -->
                <template if:true={isProcessing}>
                    <div class="slds-align_absolute-center slds-m-vertical_medium">
                        <lightning-spinner alternative-text="Processing..." variant="brand" size="large"></lightning-spinner>
                        <p class="slds-m-top_medium slds-text-heading_small">{processingMessage}</p>
                        <p class="slds-m-top_small slds-text-body_small slds-text-color_weak">{processingSubMessage}</p>
                    </div>
                </template>

                <!-- Debug Log -->
                <div class="slds-box slds-theme_shade slds-m-top_medium" style="max-height: 300px; overflow-y: auto;">
                    <h3 class="slds-text-heading_small slds-m-bottom_small">
                        <lightning-icon icon-name="utility:bug" size="x-small" class="slds-m-right_xx-small"></lightning-icon>
                        Debug Log
                    </h3>
                    <div style="font-family: monospace; font-size: 0.75rem; white-space: pre-wrap; background: #f4f6f9; padding: 0.5rem; border-radius: 0.25rem;">
                        <template if:true={hasDebugMessages}>
                            <template for:each={debugMessages} for:item="msg">
                                <div key={msg.id} class="slds-m-bottom_xxx-small">{msg.text}</div>
                            </template>
                        </template>
                        <template if:false={hasDebugMessages}>
                            <p class="slds-text-color_weak">No debug messages yet...</p>
                        </template>
                    </div>
                </div>

                <!-- Error Display -->
                <template if:true={hasError}>
                    <div class="slds-notify slds-notify_alert slds-theme_error slds-m-top_medium" role="alert">
                        <span class="slds-assistive-text">error</span>
                        <lightning-icon icon-name="utility:error" size="small" variant="inverse" class="slds-m-right_x-small"></lightning-icon>
                        <h2 class="slds-text-heading_small">Error Occurred</h2>
                        <div class="slds-m-top_small">
                            <p><strong>Error:</strong> {errorMessage}</p>
                        </div>
                    </div>
                </template>

                <!-- Success Display -->
                <template if:true={uploadComplete}>
                    <div class="slds-notify slds-notify_alert slds-theme_success slds-m-top_medium" role="alert">
                        <span class="slds-assistive-text">success</span>
                        <lightning-icon icon-name="utility:success" size="small" variant="inverse" class="slds-m-right_x-small"></lightning-icon>
                        <h2 class="slds-text-heading_small">Upload Complete!</h2>
                        <p class="slds-m-top_small">Resume has been uploaded successfully.</p>
                    </div>
                </template>

            </div>

            <!-- Footer -->
            <footer class="slds-modal__footer">
                <template if:true={uploadComplete}>
                    <lightning-button 
                        variant="brand" 
                        label="Close & Refresh" 
                        onclick={handleDone}>
                    </lightning-button>
                </template>
                
                <template if:false={uploadComplete}>
                    <lightning-button 
                        variant="neutral" 
                        label="Close" 
                        onclick={handleCancel}
                        disabled={isProcessing}>
                    </lightning-button>
                </template>
            </footer>

        </div>
    </section>
</template>